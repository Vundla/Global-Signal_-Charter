name: ğŸ†ğŸ¦ğŸ‡ UbuntuNet Global CI/CD - 90% Review Gates

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  MIX_ENV: test
  DATABASE_URL: postgresql://global-signal_-charter:Mv@10111@localhost:5432/global_DB
  
jobs:
  # ============================================
  # PHASE 1: FOUNDATION CHECKS
  # ============================================
  backend-tests:
    name: ğŸ”§ Backend Tests (Elixir/Phoenix)
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: global_DB_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”¹ Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: '26.2'
          elixir-version: '1.17'
      
      - name: ğŸ“¦ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            backend/deps
            backend/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}
      
      - name: ğŸ”§ Install Dependencies
        working-directory: backend
        run: |
          mix local.hex --force
          mix local.rebar --force
          mix deps.get
      
      - name: ğŸ—„ï¸ Setup Test Database
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/global_DB_test
        run: |
          mix ecto.create
          mix ecto.migrate
      
      - name: ğŸ§ª Run Tests
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/global_DB_test
        run: mix test
      
      - name: ğŸ“Š Code Coverage
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/global_DB_test
        run: |
          mix coveralls.json
          COVERAGE=$(jq -r '.total' cover/excoveralls.json)
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "âŒ GATE FAILED: Coverage $COVERAGE% < 90%"
            exit 1
          fi
          echo "âœ… GATE PASSED: Coverage $COVERAGE% â‰¥ 90%"
      
      - name: ğŸ” Lint with Credo
        working-directory: backend
        run: mix credo --strict
      
      - name: ğŸ”’ Security Scan (Sobelow)
        working-directory: backend
        run: |
          mix sobelow --config --exit
  
  frontend-tests:
    name: ğŸ¨ Frontend Tests (SvelteKit)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ Install Dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ğŸ§ª Run Tests
        working-directory: frontend
        run: npm test -- --coverage
      
      - name: ğŸ“Š Check Coverage
        working-directory: frontend
        run: |
          COVERAGE=$(jq -r '.total.statements.pct' coverage/coverage-summary.json)
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "âŒ GATE FAILED: Coverage $COVERAGE% < 90%"
            exit 1
          fi
          echo "âœ… GATE PASSED: Coverage $COVERAGE% â‰¥ 90%"
      
      - name: ğŸ” Lint with ESLint
        working-directory: frontend
        run: npm run lint
      
      - name: ğŸ¨ Type Check
        working-directory: frontend
        run: npm run check
      
      - name: ğŸ”’ Security Audit
        working-directory: frontend
        run: npm audit --audit-level=high
  
  pwa-validation:
    name: ğŸ“± PWA & Offline Validation
    runs-on: ubuntu-latest
    needs: [frontend-tests]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ Install Dependencies
        working-directory: frontend
        run: npm ci
      
      - name: ğŸ—ï¸ Build Production Bundle
        working-directory: frontend
        run: npm run build
      
      - name: ğŸ“Š Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:4173
          configPath: './frontend/lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
      
      - name: ğŸ” Verify Service Worker
        working-directory: frontend
        run: |
          if [ ! -f "build/service-worker.js" ]; then
            echo "âŒ GATE FAILED: Service worker not generated"
            exit 1
          fi
          echo "âœ… GATE PASSED: Service worker exists"
      
      - name: ğŸ“¦ Check PWA Manifest
        working-directory: frontend
        run: |
          if [ ! -f "build/manifest.webmanifest" ]; then
            echo "âŒ GATE FAILED: PWA manifest missing"
            exit 1
          fi
          PRECACHE_COUNT=$(grep -o '"url"' build/service-worker.js | wc -l)
          echo "Precached assets: $PRECACHE_COUNT"
          if [ "$PRECACHE_COUNT" -lt 10 ]; then
            echo "âŒ GATE FAILED: Too few precached assets ($PRECACHE_COUNT < 10)"
            exit 1
          fi
          echo "âœ… GATE PASSED: PWA manifest and precaching configured"
  
  # ============================================
  # PHASE 2: DATA & CACHING CHECKS
  # ============================================
  caching-validation:
    name: ğŸ—„ï¸ Caching Layer Validation
    runs-on: ubuntu-latest
    needs: [backend-tests]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ§ª Simulate Cache Hit Rate
        run: |
          echo "Testing cache hit rate..."
          # TODO: Implement cache testing when NGINX/Varnish is deployed
          echo "â­ï¸  Skipped: Requires deployed infrastructure"
  
  # ============================================
  # PHASE 3: SECURITY CHECKS
  # ============================================
  security-scan:
    name: ğŸ”’ Security & Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ” Trivy Vulnerability Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
      
      - name: ğŸ“Š Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: ğŸ”’ OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          path: '.'
          format: 'JSON'
          args: --failOnCVSS 7
  
  # ============================================
  # PHASE 4: CHAOS ENGINEERING (Manual Trigger)
  # ============================================
  chaos-drill:
    name: ğŸ”¥ Chaos Engineering Drill
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”¥ Run Chaos Experiment
        run: |
          echo "âš ï¸  Manual chaos drill - requires production infrastructure"
          # TODO: Integrate Chaos Toolkit when Kubernetes is deployed
  
  # ============================================
  # MASTER REVIEW GATE
  # ============================================
  review-gate:
    name: ğŸš¦ 90% Review Gate Checkpoint
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, pwa-validation, security-scan]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ“Š Calculate Phase Score
        id: score
        run: |
          # Scoring logic (simplified)
          BACKEND_PASS=${{ needs.backend-tests.result == 'success' }}
          FRONTEND_PASS=${{ needs.frontend-tests.result == 'success' }}
          PWA_PASS=${{ needs.pwa-validation.result == 'success' }}
          SECURITY_PASS=${{ needs.security-scan.result == 'success' }}
          
          SCORE=0
          [ "$BACKEND_PASS" = "true" ] && SCORE=$((SCORE + 25))
          [ "$FRONTEND_PASS" = "true" ] && SCORE=$((SCORE + 25))
          [ "$PWA_PASS" = "true" ] && SCORE=$((SCORE + 25))
          [ "$SECURITY_PASS" = "true" ] && SCORE=$((SCORE + 25))
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Phase Score: $SCORE/100"
          
          if [ "$SCORE" -lt 90 ]; then
            echo "âŒ REVIEW GATE FAILED: Score $SCORE < 90"
            exit 1
          fi
          
          echo "âœ… REVIEW GATE PASSED: Score $SCORE â‰¥ 90"
      
      - name: ğŸ†ğŸ¦ğŸ‡ Codex Seal of Approval
        if: steps.score.outputs.score >= 90
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ† Leopard: Resilience Verified"
          echo "ğŸ¦ Lion: Sovereignty Protected"
          echo "ğŸ‡ Hare: Adaptation Confirmed"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Ready for next phase"
  
  # ============================================
  # DEPLOYMENT (Only after 90% gate)
  # ============================================
  deploy-staging:
    name: ğŸš€ Deploy to Staging (Fly.io)
    runs-on: ubuntu-latest
    needs: [review-gate]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸš€ Deploy to Fly.io
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: ğŸŒ Deploy Backend
        working-directory: backend
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: flyctl deploy --remote-only
      
      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ Deployed to staging: https://ubuntunet-global.fly.dev"
          echo "ğŸ“Š Monitor: https://fly.io/apps/ubuntunet-global/monitoring"

  # ============================================
  # PRODUCTION DEPLOYMENT (Manual Approval)
  # ============================================
  deploy-production:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://ubuntunet.global
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”’ Final Security Check
        run: echo "Manual approval required - check Fly.io dashboard"
      
      - name: ğŸš€ Deploy to Production
        working-directory: backend
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy --remote-only --app ubuntunet-global-prod
      
      - name: ğŸŠ Production Deployment Complete
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ UbuntuNet Global - LIVE"
          echo "ğŸ†ğŸ¦ğŸ‡ Charter of Sovereign Unity Active"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "https://ubuntunet.global"
