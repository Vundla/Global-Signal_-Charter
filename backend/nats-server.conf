# NATS Server Configuration for Global Sovereign Network
# Phase 4: Multi-region, highly available event streaming

# Basic server configuration
server_name: "global-sovereign-nats"
port: 4222
monitor_port: 8222

# Network binding
listen: 0.0.0.0:4222

# HTTP/HTTPS monitoring
http: 0.0.0.0:8222
https: 0.0.0.0:8223

# Cluster configuration
cluster {
  name: "global-sovereign"
  listen: 0.0.0.0:6222
  
  # Cluster advertise address (set via environment)
  cluster_advertise: $CLUSTER_ADVERTISE
  
  # Routes to other cluster members
  routes: [
    nats://nats-1.nats.svc.cluster.local:6222,
    nats://nats-2.nats.svc.cluster.local:6222,
    nats://nats-3.nats.svc.cluster.local:6222
  ]
  
  # Connection configuration
  connect_retries: 30
  pool_size: 8
  
  # Compression for cluster traffic
  compression: s2
  
  # TLS for cluster
  tls {
    cert_file: /etc/nats/tls/server.crt
    key_file: /etc/nats/tls/server.key
    ca_file: /etc/nats/tls/ca.crt
    verify: true
    map_and_verify: true
  }
}

# JetStream Configuration
jetstream: {
  # Storage directory
  store_dir: /data/jetstream
  
  # Memory store limits (percentage of available)
  max_memory_store: 2G
  
  # File store limits
  max_file_store: 100G
  
  # Sync interval
  sync_interval: 100ms
  
  # Domain for multi-cluster (optional)
  domain: global
  
  # Duplicate window (for idempotency)
  unique_tag: "msg-id"
  
  # Compression for storage
  cipher: "aes"
}

# Authentication & Authorization
authorization {
  # Default user for unauthenticated connections
  default_user: "api"
  
  # Default permissions if no specific rules
  default_permissions {
    publish: null
    subscribe: null
  }
  
  # User accounts
  users: [
    {
      user: "api"
      password: $API_PASSWORD
      permissions {
        publish {
          allow: [
            "covenant.>",
            "alerts.>",
            "$JS.API.>",
            "$JS.EVENT.>"
          ]
        }
        subscribe {
          allow: [
            "covenant.>",
            "alerts.>",
            "consumer.>",
            "_INBOX.>",
            "$JS.API.>",
            "$JS.EVENT.>"
          ]
        }
      }
    },
    {
      user: "mobile"
      password: $MOBILE_PASSWORD
      permissions {
        publish {
          allow: ["user-events.>"]
        }
        subscribe {
          allow: [
            "covenant.>",
            "alerts.>",
            "consumer.>",
            "_INBOX.>"
          ]
        }
      }
    },
    {
      user: "analytics"
      password: $ANALYTICS_PASSWORD
      permissions {
        publish: null
        subscribe {
          allow: ["covenant.>", "alerts.>"]
        }
      }
    },
    {
      user: "admin"
      password: $ADMIN_PASSWORD
      permissions {
        publish {
          allow: ">"
        }
        subscribe {
          allow: ">"
        }
      }
    }
  ]
}

# Logging
logging {
  # Log level
  debug: false
  trace: false
  
  # Colored output
  colors: true
  
  # Time format for logs
  time_format: "2006-01-02 15:04:05.000 -0700"
  
  # File logging
  logfile: /var/log/nats/nats-server.log
  syslog: false
}

# Performance tuning
max_connections: 65536
max_control_line: 4096
max_payload: 8388608
write_deadline: "10s"
read_deadline: "10s"

# Graceful shutdown
lame_duck_duration: 30s
lame_duck_grace_period: 10s

# System account (for internal metrics)
system_account: $SYS

# Accounts (if using NATS Accounts)
accounts {
  $SYS {
    users [
      {
        user: "admin"
        password: $ADMIN_PASSWORD
      }
    ]
  }
}

# Gateway connections (for multi-cluster federation)
# gateway {
#   name: "global-sovereign-iad"
#   listen: "0.0.0.0:7222"
#   gateways: [
#     {
#       name: "ams"
#       url: "nats://nats-gateway-ams:7222"
#     },
#     {
#       name: "syd"
#       url: "nats://nats-gateway-syd:7222"
#     }
#   ]
# }

# Leaf node connections (for subscriber branches)
# leaf {
#   listen: "0.0.0.0:7422"
# }

# Websocket support
# websocket {
#   listen: "0.0.0.0:8080"
#   same_origin: false
#   allowed_origins: [
#     "https://app.global-sovereign.org",
#     "https://admin.global-sovereign.org"
#   ]
# }
